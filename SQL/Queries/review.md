PostgreSQL
==========

PostgreSQL is an advanced, enterprise-class, and open-source relational database system. PostgreSQL supports both SQL (relational) and JSON (non-relational) querying.

Common Use cases of PostgreSQL: A robust database in the LAPP stack, General purpose transaction database (primary database)

PostgreSQL supports the most popular programming languages: Python, JavaScript (Node.js), etc.

PostgreSQL feature highlights: Table inheritance, [Views](https://www.postgresqltutorial.com/postgresql-views/), rules, [subquery](https://www.postgresqltutorial.com/postgresql-subquery/).

Querying Data 
--------------

### Select

It is a statement to query data from a table.

The SELECT statement has the following clauses:

-   Select distinct rows using[  DISTINCT](https://www.postgresqltutorial.com/postgresql-select-distinct/) operator.

-   Sort rows using[ORDER BY](https://www.postgresqltutorial.com/postgresql-order-by/) clause.

-   Filter rows using[  WHERE](https://www.postgresqltutorial.com/postgresql-where/) clause.

-   Select a subset of rows from a table using[  LIMIT](https://www.postgresqltutorial.com/postgresql-limit/) or[  FETCH](https://www.postgresqltutorial.com/postgresql-fetch/) clause.

-   Group rows into groups using[  GROUP BY](https://www.postgresqltutorial.com/postgresql-group-by/) clause.

-   Filter groups using[  HAVING](https://www.postgresqltutorial.com/postgresql-having/) clause.

-   Join with other tables using[  joins](https://www.postgresqltutorial.com/postgresql-joins/) such as[  INNER JOIN](https://www.postgresqltutorial.com/postgresql-inner-join/),[  LEFT JOIN](https://www.postgresqltutorial.com/postgresql-left-join/),[  FULL OUTER JOIN](https://www.postgresqltutorial.com/postgresql-full-outer-join/),[  CROSS JOIN](https://www.postgresqltutorial.com/postgresql-cross-join/) clauses.

-   Perform set operations using[  UNION](https://www.postgresqltutorial.com/postgresql-union/),[  INTERSECT](https://www.postgresqltutorial.com/postgresql-intersect/), and[  EXCEPT](https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-except/).

### Order by

ORDER BY is used to sort results in ascending or descending order according to the values of one or more columns

Grouping Data
-------------

### Group By

GROUP BY allows you to group a result by one or more columns. It is also for performing operations within groups.

### Having

HAVING it's like a WHERE clause used to filter based on the result of an aggregate function (GROUP BY)

```SQL
SELECT release_year, AVG(budget) AS avg_budget, AVG(gross) AS avg_gross
FROM films
WHERE release_year > 1990
GROUP BY release_year
HAVING AVG(budget) > 60000000
ORDER BY avg_gross DESC;
```

Filtering Data
--------------

-   [Where](https://www.postgresqltutorial.com/postgresql-where/) -- filter rows based on a specified condition.

-   [Limit](https://www.postgresqltutorial.com/postgresql-limit/) -- get a subset of rows generated by a query.

-   [Fetch](https://www.postgresqltutorial.com/postgresql-fetch/)-- limit the number of rows returned by a query.

-   [In](https://www.postgresqltutorial.com/postgresql-in/) -- select data that matches any value in a list of values.

-   [Between](https://www.postgresqltutorial.com/postgresql-between/) -- select data that is a range of values.

-   [Like](https://www.postgresqltutorial.com/postgresql-like/) -- filter data based on pattern matching.

-   [Is Null](https://www.postgresqltutorial.com/postgresql-is-null/) -- check if a value is null or not.

### Where

WHERE allows you to filter based on both text and numeric values in a table

WHERE clause always comes after the FROM statement!

WHERE IN allows you to specify multiple values in a WHERE clause, making it easier and quicker to specify multiple OR conditions

```SQL
SELECT title, language
FROM films
WHERE language IN ('English','Spanish','French')
```
### Limit

LIMIT to limit the number of rows returned

### Between

BETWEEN filters values within a specified range.

BETWEEN is inclusive, meaning the beginning and end values are included in the results!

### Like

LIKE operators can be used in a WHERE clause to search for a pattern in a column.

NOT LIKE operator to find records that don't match the pattern you specify.

There are two wildcards you can use with LIKE:

    % wildcard will match zero, one, or many characters in text.
```SQL
SELECT name
FROM companies
WHERE name LIKE 'Data%';
```
Results:'Data', 'DataC' 'DataCamp', 'DataMind'

    _ wildcard will match a single character.
```SQL
SELECT name
FROM companies
WHERE name LIKE 'DataC_mp';

--Results: 'DataCamp', 'DataComp'
```
### Null

NULL represents a missing or unknown value

check for NULL values using the expression IS NULL

IS NOT NULL to filter out missing values so you only get results which are not NULL

Joins and Using
---------------

Join a table with other tables
```SQL
SELECT c.code, name, region, e.year, fertility_rate, unemployment_rate
FROM countries AS c
INNER JOIN populations AS p
ON c.code = p.country_code
INNER JOIN economies AS e
ON c.code=e.code AND e.year=p.year;
```
When the key field you'd like to join on is the same name in both tables, you can use a USING clause instead of the ON clause.
```SQL
SELECT *
FROM countries
INNER JOIN economies
USING(code)
```
Self-ish join se utilizan para comparar valores en un campo con otros valores del mismo campo dentro de la misma tabla
```SQL
SELECT p1.country_code,
     p1.size AS size2010,
     p2.size AS size2015,
     -- Calculate growth_perc
     ((p2.size - p1.size)/p1.size * 100.0) AS growth_perc
FROM populations AS p1
  -- Join to itself (alias as p2)
INNER JOIN populations AS p2
ON p1.country_code = p2.country_code
AND p1.year = p2.year - 5;
```
## Summary:

1\. INNER JOIN: only includes records in which the key is in both tables

2\. SELF JOIN: CASE with WHEN, THEN, ELSE, and END to define a new grouping field. Comparar valores en un campo con otros valores del mismo campo dentro de la misma tabla.

3\. LEFT JOIN: maintain the left table, join the right table only where the both ids match and mark the values as missing in the cells of the right table that don't match.

4\. RIGHT JOIN: does the reverse. It maintains the right table, joins the left table only where the both ids match and marks the values as missing in the cells of the left table that don't match.

5\. FULL JOIN: combines a left join and a right join. All the values of both tables are included in the new table

6\. CROSS JOIN: create all possible combinations of two tables

Las dos últimas uniones que cubriremos usan una tabla derecha para determinar qué registros mantener en la tabla izquierda

7\. Semi-join: chooses records in the first table where a condition IS met in a second table

8\. anti-join: chooses records in the first table where a condition IS NOT met in a second table

Aggregate functions
-------------------

Aggregate functions perform some calculations on data.

-   AVG() gives you the average value

-   MAX() function returns the highest value

-   MIN() function returns the lowest value

-   SUM() function returns the result of adding up the numeric values in a column

-   COUNT()  count the number of rows in one or more columns

Math Functions
--------------

| **Function** | **Description**                                                                | **Example**  | **Result** |
|--------------|--------------------------------------------------------------------------------|--------------|------------|
| ABS          | Calculate the absolute value of a number                                       | ABS(-10)     | 10         |
| Degree       | Convert radians to degrees                                                     | DEGREES(0.8) | 45.8366236 |
| ROUND        | Round a number to the nearest integer or to a specified decimal places         | ROUND(10.3)  | 10         |
| SCALE        | Return the number of decimal digits in the fractional part                     | SCALE(1.234) | 3          |
| TRUNC        | Truncate a numeric value to a whole number of  to the specified decimal places | TRUNC(12.3)  | 12         |

Logical operators
-----------------

- = equal
- <>, != not equal
- < less than
- \> greater than
- <= less than or equal to
- \>= greater than or equal to
- AND combine multiple conditions
- OR multiple conditions where some but not all of the conditions need to be met

SET Operations
--------------

What's the difference between JOIN and UNION?

UNION puts lines from queries after each other, while

JOIN makes a cartesian product and subsets it -- completely different operations

[Union](https://www.postgresqltutorial.com/postgresql-union/) -- combine result sets of multiple queries into a single result set.

[Intersect](https://www.postgresqltutorial.com/postgresql-intersect/) -- combine the result sets of two or more queries and returns a single result set that has the rows appear in both result sets.

[Except](https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-except/) -- return the rows in the first query that does not appear in the output of the second query.

Subquery
--------

Subquery is a query nested inside another query. Technically it is an additional SELECT statement contained inside parentheses, surrounded by another complete SQL statement

It can be placed in any part of the query

-   SELECT,

-   FROM

-   WHERE

-   GROUP BY

Why might I need to use a subquery?

-   To compare groups to summarized values

-   To Reshape data for multiple purposes

-   To combine data that cannot be joined (from tables where you are unable to join)

-   To filtering list with IN

Is that subquery necessary?

    Subqueries require computing power

Other links:

-   [Subquery](https://www.postgresqltutorial.com/postgresql-subquery/) -- write a query nested inside another query.

-   [ANY](https://www.postgresqltutorial.com/postgresql-any/)  -- retrieve data by comparing a value with a set of values returned by a subquery.

-   [ALL](https://www.postgresqltutorial.com/postgresql-all/) -- query data by comparing a value with a list of values returned by a subquery.

-   [EXISTS](https://www.postgresqltutorial.com/postgresql-exists/)  -- check for the existence of rows returned by a subquery.

### WHERE Subquery

Subquery in Where can only return a single column

### FROM Subquery

A subquery in FROM is an effective way of answering detailed questions that requires filtering or transforming data before including it in your final results.

You can create multiple subqueries in one FROM statement

You can join a subquery to any existing table

### SELECT Subquery

used in a SELECT statement to bring summary values into a detailed data set.

Returns a single, aggregate value

Used in mathematical calculations

Conditional Expressions & Operators
-----------------------------------

### CASE

CASE dividir un campo numérico en categorías; hacer múltiples declaraciones if-then-else de una manera simplificada en SQL.

CASE with WHEN, THEN, ELSE, and END to define a new grouping field.

```SQL
SELECT name, continent, code, surface_area,

-- First case

CASE WHEN surface_area > 2000000 THEN 'large'

      -- Second case

      WHEN surface_area > 350000 AND surface_area < 2000000 THEN 'medium'

      -- Else clause + end

      ELSE 'small' END

      -- Alias name

      AS geosize_group

-- From table

FROM countries;
```
### CASE WHEN with aggregate functions

CASE statements are great for:

    Categorizing data;

    Filtering data;

    Aggregating data.
```SQL
SELECT

     season,

     COUNT(CASE WHEN hometeam_id = 8650 AND home_goal > away_goal

     THEN id END) AS home_wins,

     COUNT(CASE WHEN awayteam_id = 8650 AND away_goal > home_goal

     THEN id END) AS away_wins

     FROM match

    GROUP BY season;
```
Managing Tables
---------------

Create new tables and modify the structure of the existing tables

### Insert

INSERT INTO product_groups (group_name)

VALUES

('Smartphone'),

('Laptop'),

('Tablet');

### Update

UPDATE courses

SET published_date = '2020-08-01' 

WHERE course_id = 3;

### Delete

DELETE FROM Customers WHERE CustomerName='Alfreds Futterkiste';

Window Function
---------------

Window function allows you to perform the calculation across a set of rows related to the current row

GROUP BY requires you to use all non-aggregate columns. (Another limitation)

Thus, you can't compare aggregate values to non-aggregate data

Solution: Window functions!

Window functions

-   are a class of functions that perform calculations on an already generated result set;

-   can be used to perform aggregate calculations without having to group data

-   Are processed after the entire query except the final ORDER BY statement

-   Uses the result set to calculate information (as opposed to using the database directly)

### OVER()

pass this aggregate value over this existing result set

Simpler syntax

Faster processing time

### RANK()

allow you to create a RANK of information according to any variable you want to use to sort your data.

### PARTITION BY

PARTITION BY

-   allows you to calculate separate values for different categories established in a partition

-   Calculate different calculations in the same column

-   Can partition data by 1 or more columns

-   Can partition aggregate calculations, ranks, etc.

Views
-----

A view is a named query that provides another way to present data in the database tables.

A view is defined based on one or more tables which are known as base tables.

When you[  create a view](https://www.postgresqltutorial.com/managing-postgresql-views/), you basically create a query and assign a name to the query.

In PostgreSQL, you can create special views called materialized views that store data physically and periodically refresh data from the base tables. The materialized views are handy in many scenarios, such as faster data access to a remote server and caching.

CREATE OR REPLACE view_name 

AS 

query